name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  check-branch:
    name: Check Branch
    runs-on: ubuntu-latest
    outputs:
      is_main: ${{ steps.check.outputs.is_main }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if tag is on main branch
        id: check
        run: |
          if git merge-base --is-ancestor ${{ github.sha }} origin/main; then
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: check-branch
    if: needs.check-branch.outputs.is_main == 'true'
    permissions:
      contents: "write"
      actions: "read"
    steps:
      - name: Wait for CI and get run ID
        id: find-ci
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Looking for CI workflow run for commit ${{ github.sha }}"

          for i in {1..60}; do
            # Check for successful run first
            RUN_ID=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/workflows/ci.yml/runs?head_sha=${{ github.sha }}&status=success&per_page=1" \
              --jq '.workflow_runs[0].id // empty')

            if [ -n "$RUN_ID" ]; then
              echo "Found successful CI run: $RUN_ID"
              echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check if CI is still running
            IN_PROGRESS=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/workflows/ci.yml/runs?head_sha=${{ github.sha }}&per_page=1" \
              --jq '.workflow_runs[0] | select(.status == "in_progress" or .status == "queued" or .status == "waiting") | .id // empty')

            if [ -n "$IN_PROGRESS" ]; then
              echo "CI run $IN_PROGRESS is still in progress, waiting 30s... (attempt $i/60)"
              sleep 30
              continue
            fi

            # Check if CI failed
            FAILED=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/workflows/ci.yml/runs?head_sha=${{ github.sha }}&status=failure&per_page=1" \
              --jq '.workflow_runs[0].id // empty')

            if [ -n "$FAILED" ]; then
              echo "CI run $FAILED failed. Cannot create release."
              exit 1
            fi

            # No CI run found at all - wait a bit in case it's just starting
            if [ $i -lt 5 ]; then
              echo "No CI run found yet, waiting 30s... (attempt $i/60)"
              sleep 30
              continue
            fi

            echo "No CI run found for commit ${{ github.sha }}"
            echo "Make sure CI has run on main before pushing a tag"
            exit 1
          done

          echo "Timed out waiting for CI to complete (30 minutes)"
          exit 1

      - name: Download binary from CI
        uses: actions/download-artifact@v5
        with:
          name: crowchiper-linux-x86_64
          path: ./binary
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ steps.find-ci.outputs.run_id }}

      - name: Create tarball
        run: |
          chmod +x ./binary/crowchiper
          tar -czvf crowchiper-linux-x86_64.tar.gz -C ./binary crowchiper

      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate release notes with git-cliff
        uses: orhun/git-cliff-action@v4
        id: cliff
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: crowchiper-linux-x86_64.tar.gz
          body: ${{ steps.cliff.outputs.content }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
